<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Clave">
  <title>Clave</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #000000;
      --surface: #0a0a0a;
      --wood: #60CDFF;
      --wood-light: #90DEFF;
      --wood-dark: #3AAFDF;
      --text: #ffffff;
      --text-muted: #555555;
      --pulse: #60CDFF;
      --radius: 16px;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0;
      padding: 24px 20px;
      min-height: 100svh;
    }



    .app {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
    }

    /* Title */
    .title {
      font-family: 'Barlow', sans-serif;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    /* BPM Display */
    .bpm-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .bpm-number {
      font-family: 'Space Mono', monospace;
      font-size: 96px;
      font-weight: 700;
      line-height: 1;
      color: var(--text);
      letter-spacing: -4px;
      transition: color 0.1s;
      cursor: text;
    }

    .bpm-number input {
      font-family: 'Space Mono', monospace;
      font-size: 96px;
      font-weight: 700;
      line-height: 1;
      color: var(--wood-light);
      letter-spacing: -4px;
      background: transparent;
      border: none;
      border-bottom: 2px solid var(--wood);
      outline: none;
      width: 3ch;
      text-align: center;
      -moz-appearance: textfield;
    }

    .bpm-number input::-webkit-outer-spin-button,
    .bpm-number input::-webkit-inner-spin-button {
      -webkit-appearance: none;
    }

    .bpm-label {
      font-family: 'Barlow', sans-serif;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.3em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Pulse ring */
    .pulse-ring {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 2px solid rgba(200,134,74,0.2);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.05s;
    }

    .pulse-ring::before {
      content: '';
      position: absolute;
      inset: 8px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(200,134,74,0.15) 0%, transparent 70%);
      transform: scale(0.3);
      opacity: 0;
      transition: transform 0.05s, opacity 0.05s;
    }

    .pulse-ring.beat::before {
      transform: scale(1);
      opacity: 1;
    }

    .pulse-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--wood);
      transform: scale(0.6);
      transition: transform 0.05s, background 0.05s;
      box-shadow: 0 0 0 0 rgba(200,134,74,0);
    }

    .pulse-ring.beat .pulse-dot {
      transform: scale(1.1);
      background: var(--wood-light);
      box-shadow: 0 0 20px rgba(232,169,106,0.5);
    }

    /* Slider section */
    .slider-section {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nudge-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid rgba(96,205,255,0.3);
      background: transparent;
      color: var(--wood);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s, border-color 0.15s;
      font-family: 'Barlow', sans-serif;
      line-height: 1;
    }

    .nudge-btn:active {
      background: rgba(200,134,74,0.15);
      border-color: var(--wood);
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      flex: 1;
      height: 3px;
      background: rgba(200,134,74,0.2);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--wood);
      border: 2px solid var(--wood-light);
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      cursor: pointer;
    }

    .range-labels {
      display: flex;
      justify-content: space-between;
      padding: 0 2px;
    }

    .range-label {
      font-size: 10px;
      color: var(--text-muted);
      letter-spacing: 0.1em;
    }

    /* Play button */
    .play-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid var(--wood);
      background: transparent;
      color: var(--wood);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s;
      position: relative;
    }

    .play-btn:active {
      background: rgba(200,134,74,0.1);
    }

    .play-btn.playing {
      background: var(--wood);
      color: var(--bg);
      box-shadow: 0 0 40px rgba(200,134,74,0.3);
    }

    .play-icon {
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 12px 0 12px 20px;
      border-color: transparent transparent transparent currentColor;
      margin-left: 4px;
      transition: opacity 0.15s;
    }

    .stop-icon {
      width: 18px;
      height: 18px;
      background: currentColor;
      border-radius: 3px;
      display: none;
    }

    .play-btn.playing .play-icon { display: none; }
    .play-btn.playing .stop-icon { display: block; }

    .controls-row {
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="bpm-display">
      <div class="bpm-number" id="bpmNumber" title="Tap to edit">90</div>
      <div class="bpm-label">BPM</div>
    </div>

    <div class="pulse-ring" id="pulseRing">
      <div class="pulse-dot"></div>
    </div>

    <div class="slider-section">
      <div class="slider-row">
        <button class="nudge-btn" id="btnDown" aria-label="Decrease BPM">−</button>
        <input type="range" id="bpmSlider" min="40" max="208" value="90" step="1">
        <button class="nudge-btn" id="btnUp" aria-label="Increase BPM">+</button>
      </div>
      <div class="range-labels">
        <span class="range-label">40</span>
        <span class="range-label">208</span>
      </div>
    </div>

    <div class="controls-row">
<button class="play-btn" id="playBtn" aria-label="Play/Stop">
        <div class="play-icon"></div>
        <div class="stop-icon"></div>
      </button>
    </div>
  </div>

  <script>
    const bpmSlider = document.getElementById('bpmSlider');
    const bpmNumber = document.getElementById('bpmNumber');
    const playBtn = document.getElementById('playBtn');
    const pulseRing = document.getElementById('pulseRing');
    const btnDown = document.getElementById('btnDown');
    const btnUp = document.getElementById('btnUp');

    let bpm = 90;
    let isPlaying = false;
    let audioCtx = null;
    let nextNoteTime = 0;
    let schedulerTimer = null;


    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    // Synthesized clave sound
    function scheduleClave(time) {
      const ctx = getAudioCtx();

      // Resonant body — short tonal burst
      const osc = ctx.createOscillator();
      const oscGain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(2500, time);
      osc.frequency.exponentialRampToValueAtTime(1800, time + 0.04);
      oscGain.gain.setValueAtTime(0.5, time);
      oscGain.gain.exponentialRampToValueAtTime(0.001, time + 0.06);
      osc.connect(oscGain);
      oscGain.connect(ctx.destination);
      osc.start(time);
      osc.stop(time + 0.07);

      // Click transient
      const noise = ctx.createOscillator();
      const noiseGain = ctx.createGain();
      noise.type = 'square';
      noise.frequency.setValueAtTime(3800, time);
      noiseGain.gain.setValueAtTime(0.3, time);
      noiseGain.gain.exponentialRampToValueAtTime(0.001, time + 0.015);
      noise.connect(noiseGain);
      noiseGain.connect(ctx.destination);
      noise.start(time);
      noise.stop(time + 0.02);

      // Visual pulse — schedule to fire at the right wall-clock time
      const delay = (time - ctx.currentTime) * 1000;
      setTimeout(() => {
        pulseRing.classList.add('beat');
        setTimeout(() => pulseRing.classList.remove('beat'), 80);
      }, Math.max(0, delay));
    }

    function scheduler() {
      const ctx = getAudioCtx();
      const scheduleAhead = 0.1; // seconds
      while (nextNoteTime < ctx.currentTime + scheduleAhead) {
        scheduleClave(nextNoteTime);
        nextNoteTime += 60.0 / bpm;
      }
      schedulerTimer = setTimeout(scheduler, 25);
    }

    function start() {
      const ctx = getAudioCtx();
      if (ctx.state === 'suspended') ctx.resume();
      nextNoteTime = ctx.currentTime + 0.05;
      scheduler();
      isPlaying = true;
      playBtn.classList.add('playing');
    }

    function stop() {
      clearTimeout(schedulerTimer);
      schedulerTimer = null;
      isPlaying = false;
      playBtn.classList.remove('playing');
      pulseRing.classList.remove('beat');
    }

    function setBPM(val) {
      bpm = Math.max(40, Math.min(208, val));
      bpmNumber.textContent = bpm;
      bpmSlider.value = bpm;
    }

    bpmNumber.addEventListener('click', () => {
      if (bpmNumber.querySelector('input')) return;
      const input = document.createElement('input');
      input.type = 'number';
      input.value = bpm;
      input.min = 40;
      input.max = 208;
      bpmNumber.textContent = '';
      bpmNumber.appendChild(input);
      input.focus();
      input.select();

      function commit() {
        const val = parseInt(input.value);
        bpmNumber.textContent = bpm;
        if (!isNaN(val)) setBPM(val);
        else bpmNumber.textContent = bpm;
      }

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { input.blur(); }
        if (e.key === 'Escape') { bpmNumber.textContent = bpm; }
      });
      input.addEventListener('blur', commit);
    });

    playBtn.addEventListener('click', () => {
      isPlaying ? stop() : start();
    });

    bpmSlider.addEventListener('input', () => setBPM(parseInt(bpmSlider.value)));

    btnDown.addEventListener('click', () => setBPM(bpm - 1));
    btnUp.addEventListener('click', () => setBPM(bpm + 1));

    // Long press nudge buttons
    let nudgeInterval = null;
    function startNudge(dir) {
      setBPM(bpm + dir);
      nudgeInterval = setInterval(() => setBPM(bpm + dir), 150);
    }
    function stopNudge() { clearInterval(nudgeInterval); nudgeInterval = null; }

    btnDown.addEventListener('pointerdown', () => startNudge(-1));
    btnUp.addEventListener('pointerdown', () => startNudge(1));
    [btnDown, btnUp].forEach(btn => {
      btn.addEventListener('pointerup', stopNudge);
      btn.addEventListener('pointerleave', stopNudge);
    });


  </script>
</body>
</html>
